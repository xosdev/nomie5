var B=Object.defineProperty;var k=Object.getOwnPropertySymbols;var C=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable;var b=(r,e,t)=>e in r?B(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,d=(r,e)=>{for(var t in e||(e={}))C.call(e,t)&&b(r,t,e[t]);if(k)for(var t of k(e))I.call(e,t)&&b(r,t,e[t]);return r};var l=(r,e,t)=>(b(r,typeof e!="symbol"?e+"":e,t),t);var n=(r,e,t)=>new Promise((s,a)=>{var i=g=>{try{h(t.next(g))}catch(f){a(f)}},o=g=>{try{h(t.throw(g))}catch(f){a(f)}},h=g=>g.done?s(g.value):Promise.resolve(g.value).then(i,o);h((t=t.apply(r,e)).next())});import{c as m,N as u,n as p,s as z,u as N,P as A,D as S,a as x,v as w,B as E,w as L,x as _,y,C as $,z as O}from"./index.35142b07.js";function v(r){return r.substr(0,1)}function T(r){let e={tick:"tick",numeric:"value",range:"range",timer:"timer"},t={};return r.trackers.forEach(s=>{s.config=s.config||{};let a={tag:c(s.label),label:s.label,color:s.color,emoji:v(s.label),min:s.config.min||"",max:s.config.max||"",uom:s.config.uom||"num",type:e[s.config.type||"tick"]||"tick",math:s.config.math||"sum"};t[a.tag]=new m(a)}),t}function Z(r){let e={};return r.trackers.forEach(t=>{let s=c(t.label);t.groups&&t.groups.forEach(a=>{(a||"").trim().length&&(e[a]=e[a]||[],e[a].indexOf(s)===-1&&e[a].push(s))})}),Object.keys(e).filter(t=>t.toLowerCase()!=="all").map(t=>({id:c(t),label:t,trackers:e[t]||[]}))}function P(r){let e={};return r.trackers.hasOwnProperty("length")&&r.trackers.forEach(t=>{let s=d({tag:c(t.label)},t);e[t._id]=new m(s)}),e}function F(r){let e=T(r),t=P(r),s=[];return r.notes.forEach(a=>{let i=new u({_id:p(10),start:a.time,end:a.time+1e3,lat:(a.geo||[]).length==2?a.geo[0]:null,lng:(a.geo||[]).length==2?a.geo[1]:null,location:"",note:a.value});s.push(i)}),r.events.forEach(a=>{if(t.hasOwnProperty(a.parent)){let i,o=e[t[a.parent].tag];o.tag,o.type==="tick"?i=`#${o.tag}`:i=`#${o.tag}(${a.value})`;let h=new u({_id:p(10),start:a.time,end:a.time+1e3,lat:(a.geo||[]).length==2?a.geo[0]:null,lng:(a.geo||[]).length==2?a.geo[1]:null,location:"",note:i});s.push(h)}}),s}function G(r){return{trackers:T(r),boards:Z(r),logs:F(r),context:[],people:{},dashboards:[],locations:[]}}function H(r){return r.substr(0,1)}function j(r){let e={tick:"tick",numeric:"value",range:"range",timer:"timer"},t={};return(r.trackers||[]).forEach(s=>{s.config=s.config||{};let a={tag:c(s.label),label:s.label,color:s.color,emoji:H(s.label),min:s.config.min||"",max:s.config.max||"",uom:s.config.uom||"num",type:e[s.config.type||"tick"]||"tick",math:s.config.math||"sum"};t[a.tag]=new m(a)}),t}function R(r){let e={};return(r.trackers||[]).forEach(t=>{let s=c(t.label);t.groups&&t.groups.forEach(a=>{(a||"").trim().length&&(e[a]=e[a]||[],e[a].indexOf(s)===-1&&e[a].push(s))})}),Object.keys(e).filter(t=>t.toLowerCase()!=="all").map(t=>({id:c(t),label:t,trackers:e[t]||[]}))}function q(r){let e={};return r.trackers.hasOwnProperty("length")&&(r.trackers||[]).forEach(t=>{let s=d({tag:c(t.label)},t);e[t._id]=new m(s)}),e}function J(r){let e=j(r),t=q(r),s=[];return(r.notes||[]).forEach(a=>{let i=new u({_id:p(10),start:a.time,end:a.time+1e3,lat:(a.geo||[]).length==2?a.geo[0]:null,lng:(a.geo||[]).length==2?a.geo[1]:null,location:"",note:a.value});s.push(i)}),(r.events||[]).forEach(a=>{if(t.hasOwnProperty(a.parent)){let i,o=e[t[a.parent].tag];o.tag,o.type==="tick"?i=`#${o.tag}`:i=`#${o.tag}(${a.value})`;let h=new u({_id:p(10),start:a.time,end:a.time+1e3,lat:(a.geo||[]).length==2?a.geo[0]:null,lng:(a.geo||[]).length==2?a.geo[1]:null,location:"",note:i});s.push(h)}}),s}function K(r){return{trackers:j(r),boards:R(r),logs:J(r),context:[],people:{},dashboards:[],locations:[]}}function M(r){let e={};return Object.keys(r.trackers).forEach(t=>{e[t]=new m(r.trackers[t])}),e}function Q(r){return(r.boards||[]).map(e=>new z(e))}function U(r){return(r.events||[]).map(e=>(e.note=e.notes,new u(e)))}function V(r){return{trackers:M(r),boards:Q(r),logs:U(r),people:{},context:[],locations:[],dashboards:[]}}function W(r){let e={};return Object.keys(r.trackers).forEach(t=>{e[t]=new m(r.trackers[t])}),e}function X(r){let e={};return Object.keys(r.people||{}).forEach(t=>{e[t]=new A(r.people[t])}),e}function Y(r){return(r.boards||[]).map(e=>new z(e))}function D(r){let e=[];return r.dashboards&&r.dashboards.dashboards?e=r.dashboards.dashboards:r.dashboards&&(e=r.dashboards),e=e.map(t=>new S(t)),e}function ee(r){return(r.events||[]).map(e=>new u(e))}function te(r){return{trackers:W(r),boards:Y(r),logs:ee(r),people:X(r),context:r.context||[],locations:(r.locations||[]).map(t=>new N(t)),dashboards:D(r)}}function c(r){return r&&r.match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g).map(e=>e.toLowerCase()).join("_")}class re{constructor(e){l(this,"original");l(this,"version");l(this,"normalized");var t,s;if(this.original=e,this.version=parseInt((s=(t=e==null?void 0:e.nomie)==null?void 0:t.number)==null?void 0:s.split(".")[0]),console.log("THE ORIGINAL",this.version),this.version)this.version>=4?this.normalized=te(e):this.version==3?this.normalized=V(e):this.version==2?this.normalized=K(e):this.version==1&&(this.normalized=G(e));else throw new Error("Invalid Nomie Backup file")}}class ie{constructor(){l(this,"normalized");l(this,"raw");l(this,"changeListeners");l(this,"importing",{});l(this,"importer");this.importing={}}onChange(e){this.changeListeners.indexOf(e)==-1&&this.changeListeners.push(e)}logs(e){return this.normalized={logs:e},this}openPayload(e){return n(this,null,function*(){this.raw=e,this.importer=new re(e),this.normalized=this.importer.normalized})}importAll(e){return n(this,null,function*(){e=e||function(t){};try{return e({importing:"boards"}),yield this.importBoards(),e({importing:"trackers"}),yield this.importTrackers(),e({importing:"dashboards"}),yield this.importDashboards(),e({importing:"people"}),yield this.importPeople(),e({importing:"context"}),yield this.importContext(),e({importing:"locations"}),yield this.importLocations(),e({importing:"logs"}),yield this.importLogs(e),!0}catch(t){throw console.error(t),new Error(t.message)}})}importTrackers(){return n(this,null,function*(){return yield x.save(d(d({},this.normalized.trackers),x.data())),this})}importDashboards(){return n(this,null,function*(){let e=yield w.get();return w.update(t=>(this.normalized.dashboards=(this.normalized.dashboards||[]).filter(s=>(e||[]).map(a=>a.id).indexOf(s.id)==-1),t.dashboards=[...this.normalized.dashboards,...e],t)),yield w.save(),this})}importBoards(){return n(this,null,function*(){let e=E.data().boards||[];return yield E.save([...this.normalized.boards,...e]),this})}importLogs(e){return n(this,null,function*(){return yield L.import(this.normalized.logs,t=>{if(t.step){let s;t.step<t.total?s=_.round(100-(t.total-t.step)/t.total*100):t.step==t.total?s=100:s=0,e&&e({message:`Step ${t.step} of ${t.total}`,progress:s,step:t.step,total:t.total})}}),yield L.getFirstDate(!0),this})}importPeople(){return n(this,null,function*(){let e=yield y.getPeople();return e=e||{},yield y.write(d(d({},(this.normalized||{people:{}}).people),e)),e})}importContext(){return n(this,null,function*(){let e=yield $.get();return e=e||[],this.normalized.context=this.normalized.context||[],this.normalized.context.forEach(t=>{e.indexOf(t)==-1&&e.push(t)}),yield $.write(e),this})}importLocations(){return n(this,null,function*(){let e=O.getAll();return this.normalized.locations=this.normalized.locations||[],this.normalized.locations.forEach(t=>{e.find(s=>s.id==t.id)||e.push(t)}),yield O.write(e),this})}fireChange(e){this.changeListeners.forEach(t=>{t(e)})}}export{ie as I};
